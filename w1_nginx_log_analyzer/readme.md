# Программа log_analyzer
## 1 Назначение и состав программы

1.1 Программа предназначена для анализа файлов протоколирования (далее, лог-файлов), сгенерированных модулем [ngx_http_log_module](http://nginx.org/en/docs/http/ngx_http_log_module.html) с целью выявления проблемных ресурсов web-сервиса. 

1.2 Программа анализирует последний лог-файл и генерирует отчет в формате html. 

1.3 Для работы программы используются следующие файлы, которые должны находиться в рабочем каталоге: 
* _log_analyzer.py_ 
* _report.html_ (шаблон) 

## 2 Входные данные и параметры конфигурации
2.1 Входными данными являются лог-файл и файл конфигурации. 

2.2 Программа разработана и протестирована для следующего формата протоколирования:  
`$remote_addr  $remote_user $http_x_real_ip [$time_local] "$request" ' $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for" "$http_X_REQUEST_ID" "$http_X_RB_USER" $request_time`  
_Примечание - формат протоколирования может быть изменен, однако необходимо, чтобы присутствовали поля  `"$request"` и далее `$request_time` _

2.3 Лог-файл должен иметь кодировку UTF-8. Допускается помещать файлы в архив gzip. Имена лог-файлов должны соответствовать формату: 
_nginx-access-ui.log-YYYYMMDD_ или _nginx-access-ui.log-YYYYMMDD.gz_ (для архива)

2.4 В параметре командной строки программы указывается путь к файлу конфигурации. Если файл не указан, то используются параметры по умолчанию заданные в app/library/config.py

2.5 Файл конфигурации представляет собой текстовый файл, в котором указаны параметры в формате JSON. 
Назначение параметров приведено в таблице. Если в файле конфигурации не задан какой-либо параметр, то используется значение по умолчанию

Параметр  | Описание                                                                                                                                | 
:-------- |:--------------------------------------------------------------------------------------------------------------------------------|
LOGS: str = None | Путь к папке, в которой находятся лог-файлы работы программы. Может быть не указан. В таком случае логи будут выводится в stdout. Если заданной директории нет, она создается автоматически |
REPORT_SIZE: int = 1000 | Количество URL с наибольшим суммарным временем обработки в отчете                                                               |
REPORT_DIR: str = "./reports" | Путь к папке, в которой помещаются отчеты (результат анализа)                                                                   |
TEMPLATE_DIR: str = "app/resources/templates" | Путь к темплейту файла отчета                                                                                                   |
LOG_DIR: str = "./data" | Путь к папке, в которой находятся лог-файлы nginx                                                                               |
ERROR_THRESHOLD: int = 40 | Допустимый предел ошибок                                                                                                        |           |
NGINX_FILE_MASK: str = r"nginx-access-ui\.log-(?P<date>\d{8})(\.gz)?$" |фильтр для поиска лог-файлов соответствующих формату|


## 3 Выходные данные
3.1 Для последнего лог файла, создается отчет в формате 
_report-YYYY.MM.DD.html_, который помещается в папку `REPORT_DIR` (указывается в файле конфигурации). 

3.2 При просмотре отчета в браузере таблица строки таблицы могут быть отсортированы. Для этого необходимо нажать на заглавие столбца.

3.3 Ход работы и ошибки выполнения программы выводятся на экран или, если задан `REPORT_DIR`, в соответствующем файле отчета работы программы.

## 4 Запуск программы
4.1 Программа представляет собой скрипт для Python 3.9+. Для запуска должен быть установлен соответствующий интерпретатор.

4.2 Для запуска программы выполнить команду  
_`>>> python log_analyzer.py`_   
или _`>>> python log_analyzer.py --config==’путь к файлу конфигурации’`_

_`>>>python ./log_analyzer.py --help`_ - вывод помощи

## 5 Запуск тестов
5.1 Для программы разработана система тестов на базе unittest (директория ./tests).

5.2 Для запуска тестов используйте:  
_`>>> python test__script__name__.py`_
